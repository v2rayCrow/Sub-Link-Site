<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="نمایش کانفیگ‌های فانتزی V2Ray با طراحی زیبا و جستجوی پیشرفته">
  <meta name="keywords" content="V2Ray, کانفیگ, VPN, پرچم کشورها, فانتزی">
  <title>کانفیگ‌های فانتزی V2Ray</title>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-day: #e6f3ff;
      --bg-night: #1a1a3d;
      --text-day: #1a1a1a;
      --text-night: #f0f0f0;
      --primary-color: #ff6f61;
      --secondary-color: #ffd700;
      --card-shadow: rgba(0, 0, 0, 0.2);
      --card-hover-shadow: rgba(0, 0, 0, 0.3);
      --gradient-overlay: linear-gradient(to right, rgba(0, 0, 0, 0.5), transparent);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Vazirmatn', 'Poppins', sans-serif;
      margin: 0;
      padding: 20px;
      background: var(--bg-day);
      color: var(--text-day);
      transition: background 0.5s ease, color 0.5s ease;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    body.night {
      background: var(--bg-night);
      color: var(--text-night);
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    header h1 {
      margin: 0;
      font-size: 2rem;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      -webkit-background-clip: text;
      color: transparent;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
    }

    #lastUpdate {
      font-size: 0.9rem;
      opacity: 0.8;
    }

    /* کنترل‌ها */
    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    input[type="search"] {
      flex: 1;
      padding: 12px;
      border-radius: 20px;
      border: 1px solid #ccc;
      background: rgba(255, 255, 255, 0.9);
      text-align: right;
      font-size: 1rem;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    input[type="search"]:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 8px rgba(255, 111, 97, 0.3);
      outline: none;
    }

    button {
      padding: 10px 16px;
      border: none;
      border-radius: 20px;
      background: var(--primary-color);
      color: #fff;
      cursor: pointer;
      font-size: 0.9rem;
      transition: transform 0.2s ease, background 0.3s ease;
    }

    button:hover {
      transform: translateY(-2px);
      background: var(--secondary-color);
    }

    /* کارت کشور */
    .country-card {
      padding: 20px;
      border-radius: 25px;
      cursor: pointer;
      background: linear-gradient(to right, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
      box-shadow: 0 8px 25px var(--card-shadow);
      margin-bottom: 20px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .country-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-size: cover;
      background-position: left center;
      opacity: 0.3;
      z-index: -1;
      transition: opacity 0.3s ease;
    }

    .country-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 30px var(--card-hover-shadow);
    }

    .country-card:hover::before {
      opacity: 0.5;
    }

    .country-name {
      font-weight: 600;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text-day);
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
    }

    body.night .country-name {
      color: var(--text-night);
    }

    /* لیست کانفیگ‌ها */
    .config-list {
      margin-top: 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .config-card {
      background: rgba(0, 0, 0, 0.6);
      padding: 15px;
      border-radius: 15px;
      font-family: monospace;
      word-break: break-all;
      color: #fff;
      white-space: pre-wrap;
      transition: background 0.3s ease, transform 0.2s ease;
    }

    .config-card:hover {
      background: rgba(0, 0, 0, 0.75);
      transform: translateX(5px);
    }

    .config-preview {
      overflow: hidden;
      max-height: 3.5em;
      font-size: 0.85rem;
    }

    /* دکمه‌ها */
    .actions {
      margin-top: 10px;
      display: flex;
      gap: 8px;
    }

    .small {
      padding: 8px 14px;
      border-radius: 10px;
      background: var(--primary-color);
      color: #fff;
      font-size: 0.85rem;
    }

    .small:hover {
      background: var(--secondary-color);
    }

    .show-more {
      background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
      color: #fff;
      border-radius: 15px;
      padding: 8px 20px;
      align-self: center;
      margin-top: 10px;
    }

    .show-more:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }

    /* دکمه شب/روز */
    #themeSwitch {
      width: 60px;
      height: 30px;
      background: linear-gradient(45deg, #87ceeb, #00b7eb);
      border-radius: 15px;
      cursor: pointer;
      display: flex;
      align-items: center;
      padding: 3px;
      transition: background 0.3s ease;
    }

    body.night #themeSwitch {
      background: linear-gradient(45deg, #1c2f4a, #3b5998);
    }

    #slider {
      width: 24px;
      height: 24px;
      background: #fff;
      border-radius: 50%;
      transition: transform 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    body.night #slider {
      transform: translateX(32px);
    }

    #slider img {
      width: 18px;
      height: 18px;
    }

    /* فوتر ثابت */
    .fixed-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 20px;
      background: rgba(255, 255, 255, 0.95);
      padding: 10px 0;
      backdrop-filter: blur(10px);
      z-index: 1000;
    }

    body.night .fixed-footer {
      background: rgba(30, 30, 60, 0.95);
    }

    .fixed-footer a {
      display: flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      color: var(--text-day);
      font-weight: 600;
      padding: 8px 15px;
      border-radius: 10px;
      transition: background 0.3s ease, color 0.3s ease;
    }

    body.night .fixed-footer a {
      color: var(--text-night);
    }

    .fixed-footer a:hover {
      background: var(--primary-color);
      color: #fff;
    }

    /* واکنش‌گرایی */
    @media (max-width: 600px) {
      header h1 { font-size: 1.5rem; }
      .controls { flex-direction: column; }
      .country-card { padding: 15px; }
      .country-name { font-size: 1rem; }
    }
  </style>
</head>
<body class="day">
  <header>
    <h1>کانفیگ‌های فانتزی V2Ray</h1>
    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
      <div id="lastUpdate">آخرین آپدیت: در حال دریافت...</div>
      <div id="themeSwitch"><div id="slider"><img id="sliderIcon" src="https://img.icons8.com/emoji/48/sun-emoji.png" alt="تم روشن"></div></div>
    </div>
  </header>
  <main>
    <div class="controls">
      <input id="q" type="search" placeholder="جستجو: کشور یا کانفیگ..." aria-label="جستجوی کانفیگ‌ها">
      <button id="refresh">♻️ بارگذاری مجدد</button>
    </div>
    <div id="status" aria-live="polite"></div>
    <div id="countryList"></div>
  </main>
  <div style="height: 80px;"></div>
  <footer class="fixed-footer">
    <a href="https://t.me/v2source" target="_blank">
      <img src="https://img.icons8.com/fluency/24/telegram-app.png" alt="تلگرام" loading="lazy">کانال تلگرام
    </a>
    <a href="https://github.com/v2rayCrow" target="_blank">
      <img src="https://img.icons8.com/ios-filled/24/github.png" alt="گیت‌هاب" loading="lazy">GitHub
    </a>
  </footer>
  <script>
    const RAW_ALL = 'https://cors.bridged.cc/https://raw.githubusercontent.com/v2rayCrow/Sub-Link-Output/main/all.txt';
    let countryGroups = {};
    let configsData = [];
    let nightMode = false;

    const countryListEl = document.getElementById('countryList');
    const statusEl = document.getElementById('status');
    const lastUpdateEl = document.getElementById('lastUpdate');
    const qEl = document.getElementById('q');
    const themeSwitch = document.getElementById('themeSwitch');
    const slider = document.getElementById('slider');
    const sliderIcon = document.getElementById('sliderIcon');

    function toggleTheme() {
      nightMode = !nightMode;
      document.body.className = nightMode ? 'night' : 'day';
      sliderIcon.src = nightMode ? 'https://img.icons8.com/emoji/48/moon-emoji.png' : 'https://img.icons8.com/emoji/48/sun-emoji.png';
      sliderIcon.alt = nightMode ? 'تم تاریک' : 'تم روشن';
      renderCountries(qEl.value.trim().toLowerCase());
    }

    themeSwitch.onclick = toggleTheme;
    qEl.oninput = () => renderCountries(qEl.value.trim().toLowerCase());
    document.getElementById('refresh').onclick = loadConfigs;

    async function fetchText(url, retries = 3) {
      for (let i = 0; i < retries; i++) {
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
          return await response.text();
        } catch (e) {
          if (i === retries - 1) throw e;
          await new Promise(resolve => setTimeout(resolve, 1000));
        }
      }
    }

    function decodeVMess(vmess) {
      try {
        const b64 = vmess.slice(8);
        if (!/^[A-Za-z0-9+/=]+$/.test(b64)) throw new Error('Invalid base64');
        const decoded = atob(b64);
        if (!decoded) throw new Error('Empty decoded content');
        return decoded;
      } catch (e) {
        console.error('Error decoding VMess:', e);
        return null;
      }
    }

    function processLine(line) {
      line = line.trim();
      if (!line || line.startsWith('Provider') || line.startsWith('نامشخص') || line.startsWith('آخرین آپدیت')) return null;

      let remarkMatch = line.match(/#(.+)$/);
      let remark = remarkMatch ? remarkMatch[1] : '';
      if (line.startsWith('vmess://')) {
        const decoded = decodeVMess(line);
        if (!decoded) return null;
        line = line.slice(0, 8) + btoa(decoded);
      }
      return { raw: line, remark };
    }

    async function loadConfigs() {
      statusEl.textContent = 'در حال دریافت کانفیگ‌ها...';
      try {
        const cached = localStorage.getItem('configs');
        if (cached) {
          configsData = JSON.parse(cached);
          renderCountries();
        }
        const text = await fetchText(RAW_ALL);
        const lines = text.split('\n');
        configsData = [];
        countryGroups = {};
        lines.forEach(l => {
          const processed = processLine(l);
          if (processed) {
            configsData.push(processed);
            let country = processed.remark.split('')[0].trim() || 'نامشخص';
            if (!countryGroups[country]) countryGroups[country] = [];
            countryGroups[country].push(processed);
          }
        });

        delete countryGroups['نامشخص'];
        delete countryGroups['Provider❤️@V2Source'];

        const firstLine = lines.find(l => l.startsWith('vless://'));
        if (firstLine) {
          const updateMatch = firstLine.match(/#%D8%A2%D8%AE%D8%B1%DB%8C%D9%86.+؟(.*)/);
          lastUpdateEl.textContent = updateMatch ? `آخرین آپدیت: ${updateMatch[1]}` : 'آخرین آپدیت: نامشخص';
        }

        localStorage.setItem('configs', JSON.stringify(configsData));
        renderCountries();
        statusEl.textContent = `تعداد کشورها: ${Object.keys(countryGroups).length}`;
      } catch (e) {
        console.error(e);
        statusEl.textContent = 'خطا در دریافت کانفیگ‌ها! از داده‌های کش استفاده شد.';
      }
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => alert('کانفیگ کپی شد!')).catch(() => alert('خطا در کپی کردن!'));
    }

    function copyAllConfigs(country) {
      const allConfigs = countryGroups[country].map(cfg => cfg.raw).join('\n');
      copyToClipboard(allConfigs);
    }

    function renderCountries(filter = '') {
      countryListEl.innerHTML = '';
      Object.keys(countryGroups).sort((a, b) => countryGroups[b].length - countryGroups[a].length).forEach(country => {
        if (filter && !country.toLowerCase().includes(filter) && !countryGroups[country].some(cfg => cfg.raw.toLowerCase().includes(filter))) return;

        const card = document.createElement('div');
        card.className = 'country-card';
        card.style.backgroundImage = `var(--gradient-overlay), url('https://flagcdn.com/w320/${country.slice(0, 2).toLowerCase()}.png')`;

        const nameEl = document.createElement('div');
        nameEl.className = 'country-name';
        nameEl.innerHTML = `<span style="background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.8)); padding: 5px 10px; border-radius: 10px;">${country} (${countryGroups[country].length})</span>`;
        card.appendChild(nameEl);

        const configList = document.createElement('div');
        configList.className = 'config-list';

        let configs = countryGroups[country];
        let visibleCount = 0;

        function renderNext(n = 5) {
          for (let i = visibleCount; i < Math.min(visibleCount + n, configs.length); i++) {
            const cfg = configs[i];
            const cfgCard = document.createElement('div');
            cfgCard.className = 'config-card';
            const preview = document.createElement('div');
            preview.className = 'config-preview';
            preview.textContent = cfg.raw.split('\n').slice(0, 2).join('\n') + (cfg.raw.split('\n').length > 2 ? '\n...' : '');
            cfgCard.appendChild(preview);

            const actions = document.createElement('div');
            actions.className = 'actions';
            const copyBtn = document.createElement('button');
            copyBtn.className = 'small';
            copyBtn.textContent = 'کپی';
            copyBtn.onclick = () => copyToClipboard(cfg.raw);
            actions.appendChild(copyBtn);
            configList.appendChild(cfgCard);
          }
          visibleCount += n;
          showMoreBtn.style.display = visibleCount < configs.length ? 'block' : 'none';
        }

        const showMoreBtn = document.createElement('button');
        showMoreBtn.className = 'show-more';
        showMoreBtn.textContent = 'نمایش بیشتر';
        showMoreBtn.onclick = () => renderNext(5);

        const copyAllBtn = document.createElement('button');
        copyAllBtn.className = 'small';
        copyAllBtn.textContent = 'کپی همه';
        copyAllBtn.onclick = () => copyAllConfigs(country);
        nameEl.appendChild(copyAllBtn);

        renderNext(5);
        card.appendChild(configList);
        if (visibleCount < configs.length) card.appendChild(showMoreBtn);
        countryListEl.appendChild(card);
      });
    }

    // لود اولیه
    loadConfigs();
  </script>
</body>
</html>
