<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="کانفیگ رایگان">
  <meta name="keywords" content="V2Ray, کانفیگ, VPN, فانتزی, شیک">
  <title>کانفیگ‌های رایگان v2ray</title>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-day: linear-gradient(135deg, #e2e8f0, #f1f5f9);
      --bg-night: linear-gradient(135deg, #1e293b, #2d3748);
      --text-day: #1f2937;
      --text-night: #e5e7eb;
      --primary-color: #6366f1;
      --secondary-color: #f59e0b;
      --card-shadow: rgba(0, 0, 0, 0.15);
      --card-hover-shadow: rgba(0, 0, 0, 0.25);
      --config-bg: linear-gradient(45deg, #e0e7ff, #f3e8ff);
      --config-bg-night: linear-gradient(45deg, #312e81, #4c1d95);
      --colors: #6366f1, #f59e0b, #10b981, #ec4899, #06b6d4, #a78bfa;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Vazirmatn', 'Poppins', sans-serif;
      margin: 0;
      padding: 20px;
      background: var(--bg-day);
      color: var(--text-day);
      transition: all 0.5s ease;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    body.night {
      background: var(--bg-night);
      color: var(--text-night);
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    header h1 {
      margin: 0;
      font-size: 2rem;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      -webkit-background-clip: text;
      color: transparent;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
      animation: pulse 2s infinite ease-in-out;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.03); }
      100% { transform: scale(1); }
    }

    #lastUpdate {
      font-size: 0.9rem;
      background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
      -webkit-background-clip: text;
      color: transparent;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
    }

    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    input[type="search"] {
      flex: 1;
      padding: 12px;
      border-radius: 20px;
      border: 1px solid #ccc;
      background: linear-gradient(45deg, rgba(255, 255, 255, 0.95), rgba(243, 244, 246, 0.95));
      text-align: right;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    body.night input[type="search"] {
      background: linear-gradient(45deg, rgba(55, 65, 81, 0.95), rgba(75, 85, 99, 0.95));
      border-color: #4b5563;
    }

    input[type="search"]:hover {
      transform: scale(1.02);
    }

    input[type="search"]:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 8px rgba(99, 102, 241, 0.3);
      outline: none;
      transform: scale(1.05);
    }

    button {
      padding: 10px 16px;
      border: none;
      border-radius: 20px;
      background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
      color: #fff;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }

    button:hover {
      transform: translateY(-2px);
      opacity: 0.9;
    }

    .country-card {
      padding: 15px;
      border-radius: 25px;
      cursor: pointer;
      background: linear-gradient(45deg, rgba(255, 255, 255, 0.9), rgba(243, 244, 246, 0.9));
      box-shadow: 0 8px 25px var(--card-shadow);
      margin-bottom: 20px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      animation: slideIn 0.5s ease-out;
    }

    body.night .country-card {
      background: linear-gradient(45deg, rgba(55, 65, 81, 0.9), rgba(75, 85, 99, 0.9));
    }

    .country-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 30px var(--card-hover-shadow);
      opacity: 0.95;
    }

    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .country-name {
      font-weight: 600;
      font-size: 1.2rem;
      flex: 1;
      text-align: center;
      color: var(--text-day);
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
      transition: transform 0.3s ease;
    }

    body.night .country-name {
      color: var(--text-night);
      text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.2);
    }

    .country-name:hover {
      transform: scale(1.05);
    }

    .config-section {
      padding: 20px;
      border-radius: 25px;
      background: var(--config-bg);
      box-shadow: 0 8px 25px var(--card-shadow);
      margin-bottom: 20px;
      animation: fadeIn 0.5s ease-out;
    }

    body.night .config-section {
      background: var(--config-bg-night);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    .config-list {
      margin-top: 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .config-card {
      background: linear-gradient(45deg, rgba(0, 0, 0, 0.5), rgba(75, 85, 99, 0.5));
      padding: 15px;
      border-radius: 15px;
      font-family: monospace;
      word-break: break-all;
      color: #fff;
      white-space: pre-wrap;
      transition: all 0.3s ease;
      animation: slideIn 0.5s ease-out;
    }

    .config-card:hover {
      background: linear-gradient(45deg, rgba(0, 0, 0, 0.65), rgba(75, 85, 99, 0.65));
      transform: translateX(5px);
    }

    .config-preview {
      overflow: hidden;
      max-height: 3.5em;
      font-size: 0.85rem;
    }

    .actions {
      margin-top: 10px;
      display: flex;
      gap: 8px;
    }

    .small {
      padding: 8px 14px;
      border-radius: 10px;
      background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
      color: #fff;
      font-size: 0.85rem;
      transition: all 0.3s ease;
    }

    .small:hover {
      transform: scale(1.1);
    }

    .show-more {
      background: linear-gradient(45deg, #10b981, #ec4899);
      color: #fff;
      border-radius: 15px;
      padding: 8px 20px;
      align-self: center;
      margin-top: 10px;
      transition: all 0.3s ease;
    }

    .show-more:hover {
      transform: translateY(-2px);
    }

    #themeSwitch {
      width: 60px;
      height: 30px;
      background: linear-gradient(45deg, #93c5fd, #3b82f6);
      border-radius: 15px;
      cursor: pointer;
      display: flex;
      align-items: center;
      padding: 3px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    body.night #themeSwitch {
      background: linear-gradient(45deg, #4c1d95, #7c3aed);
    }

    #themeSwitch:hover {
      transform: scale(1.1);
    }

    #slider {
      width: 24px;
      height: 24px;
      background: #fff;
      border-radius: 50%;
      transition: transform 0.5s ease-in-out;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      position: relative;
    }

    body.night #slider {
      transform: translateX(26px);
    }

    #slider img {
      width: 18px;
      height: 18px;
      transition: opacity 0.3s ease;
    }

    .fixed-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 20px;
      background: linear-gradient(45deg, rgba(255, 255, 255, 0.95), rgba(243, 244, 246, 0.95));
      padding: 10px 0;
      backdrop-filter: blur(10px);
      z-index: 1000;
    }

    body.night .fixed-footer {
      background: linear-gradient(45deg, rgba(55, 65, 81, 0.95), rgba(75, 85, 99, 0.95));
    }

    .fixed-footer a {
      display: flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      color: var(--text-day);
      font-weight: 600;
      padding: 8px 15px;
      border-radius: 10px;
      transition: all 0.3s ease;
    }

    body.night .fixed-footer a {
      color: var(--text-night);
    }

    .fixed-footer a:hover {
      background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
      color: #fff;
      transform: scale(1.1);
    }

    @media (max-width: 600px) {
      header h1 { font-size: 1.5rem; }
      .controls { flex-direction: column; }
      .country-card { padding: 10px; }
      .country-name { font-size: 1rem; }
    }

    #status.loading::before {
      content: '';
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid var(--primary-color);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="day">
  <header>
    <h1>کانفیگ های رایگان v2ray</h1>
    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
      <div id="lastUpdate">آخرین آپدیت: در حال دریافت...</div>
      <div id="themeSwitch"><div id="slider"><img id="sliderIcon" src="https://img.icons8.com/fluency/48/sun.png" alt="تم روشن"></div></div>
    </div>
  </header>
  <main>
    <div class="controls">
      <input id="q" type="search" placeholder="جستجو: کشور یا کانفیگ..." aria-label="جستجوی کانفیگ‌ها">
      <button id="refresh">♻️ بارگذاری مجدد</button>
    </div>
    <div id="status" aria-live="polite"></div>
    <div id="countryList"></div>
  </main>
  <div style="height: 80px;"></div>
  <footer class="fixed-footer">
    <a href="https://t.me/v2source" target="_blank">
      <img src="https://img.icons8.com/fluency/24/telegram-app.png" alt="تلگرام" loading="lazy">کانال تلگرام
    </a>
    <a href="https://github.com/v2rayCrow" target="_blank">
      <img src="https://img.icons8.com/ios-filled/24/github.png" alt="گیت‌هاب" loading="lazy">GitHub
    </a>
  </footer>
  <script>
    const RAW_ALL = 'https://api.allorigins.win/raw?url=https://raw.githubusercontent.com/v2rayCrow/Sub-Link-Output/main/all.txt';
    let countryGroups = {};
    let configsData = [];
    let nightMode = false;
    let selectedCountry = null;

    const countryListEl = document.getElementById('countryList');
    const statusEl = document.getElementById('status');
    const lastUpdateEl = document.getElementById('lastUpdate');
    const qEl = document.getElementById('q');
    const themeSwitch = document.getElementById('themeSwitch');
    const slider = document.getElementById('slider');
    const sliderIcon = document.getElementById('sliderIcon');
    const colors = ['#6366f1', '#f59e0b', '#10b981', '#ec4899', '#06b6d4', '#a78bfa'];

    function toggleTheme() {
      nightMode = !nightMode;
      document.body.className = nightMode ? 'night' : 'day';
      sliderIcon.src = nightMode ? 'https://img.icons8.com/fluency/48/moon.png' : 'https://img.icons8.com/fluency/48/sun.png';
      sliderIcon.alt = nightMode ? 'تم تاریک' : 'تم روشن';
      renderCountries(qEl.value ? qEl.value.trim().toLowerCase() : '');
    }

    themeSwitch.onclick = toggleTheme;
    qEl.oninput = () => renderCountries(qEl.value ? qEl.value.trim().toLowerCase() : '');
    document.getElementById('refresh').onclick = loadConfigs;

    async function fetchText(url, retries = 3) {
      for (let i = 0; i < retries; i++) {
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
          return await response.text();
        } catch (e) {
          if (i === retries - 1) throw e;
          await new Promise(resolve => setTimeout(resolve, 1000));
        }
      }
    }

    function decodeVMess(vmess) {
      try {
        const b64 = vmess.slice(8);
        if (!/^[A-Za-z0-9+/=]+$/.test(b64)) throw new Error('Invalid base64');
        const decoded = atob(b64);
        if (!decoded) throw new Error('Empty decoded content');
        return decoded;
      } catch (e) {
        console.error('Error decoding VMess:', e);
        return null;
      }
    }

    function processLine(line) {
      line = line.trim();
      if (!line || line.includes('آخرین%20آپدیت') || line.includes('Provider❤️@V2Source')) return null;

      let remarkMatch = line.match(/#(.+)$/);
      let remark = remarkMatch ? remarkMatch[1].trim() : 'نامشخص';
      let country = remark.split(' ')[0]?.trim() || 'نامشخص';
      country = decodeURIComponent(country).replace(/�.*$/, '');

      if (line.startsWith('vmess://')) {
        const decoded = decodeVMess(line);
        if (!decoded) return null;
        line = line.slice(0, 8) + btoa(decoded);
      }
      return { raw: line, remark, country };
    }

    async function loadConfigs() {
      statusEl.classList.add('loading');
      statusEl.textContent = 'در حال دریافت کانفیگ‌ها...';
      try {
        const cached = localStorage.getItem('configs');
        if (cached) {
          configsData = JSON.parse(cached);
          renderCountries();
        }
        const text = await fetchText(RAW_ALL);
        const lines = text.split('\n').filter(line => line.trim());
        configsData = [];
        countryGroups = {};

        let updateTime = 'نامشخص';
        const updateLine = lines.find(l => l.includes('آخرین%20آپدیت'));
        if (updateLine) {
          const updateMatch = updateLine.match(/آخرین%20آپدیت.*?:(.+)$/);
          updateTime = updateMatch ? updateMatch[1].trim() : 'نامشخص';
        }
        lastUpdateEl.textContent = `آخرین آپدیت: ${updateTime}`;

        lines.forEach(l => {
          const processed = processLine(l);
          if (processed) {
            configsData.push(processed);
            let country = processed.country;
            if (!countryGroups[country]) countryGroups[country] = [];
            countryGroups[country].push(processed);
          }
        });

        delete countryGroups['نامشخص'];

        localStorage.setItem('configs', JSON.stringify(configsData));
        renderCountries();
        statusEl.textContent = `تعداد کشورها: ${Object.keys(countryGroups).length}`;
      } catch (e) {
        console.error('Error loading configs:', e);
        statusEl.textContent = 'خطا در دریافت کانفیگ‌ها! از داده‌های کش استفاده شد.';
      } finally {
        statusEl.classList.remove('loading');
      }
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => alert('کانفیگ کپی شد!')).catch(() => alert('خطا در کپی کردن!'));
    }

    function copyAllConfigs(country) {
      const allConfigs = countryGroups[country].map(cfg => cfg.raw).join('\n');
      copyToClipboard(allConfigs);
    }

    function renderCountries(filter = '') {
      countryListEl.innerHTML = '';
      if (selectedCountry && countryGroups[selectedCountry]) {
        renderConfigs(selectedCountry);
        return;
      }

      Object.keys(countryGroups).sort().forEach((country, index) => {
        if (filter && !country.toLowerCase().includes(filter) && !countryGroups[country].some(cfg => cfg.raw.toLowerCase().includes(filter))) return;

        const card = document.createElement('div');
        card.className = 'country-card';
        card.style.background = `linear-gradient(45deg, ${colors[index % colors.length]}, ${colors[(index + 1) % colors.length]})`;
        card.onclick = () => {
          selectedCountry = country;
          renderCountries(filter);
        };

        const nameEl = document.createElement('div');
        nameEl.className = 'country-name';
        nameEl.innerHTML = `<span>${country} (${countryGroups[country].length})</span>`;
        card.appendChild(nameEl);

        countryListEl.appendChild(card);
      });
    }

    function renderConfigs(country) {
      countryListEl.innerHTML = '';
      const backBtn = document.createElement('button');
      backBtn.className = 'small';
      backBtn.textContent = 'بازگشت به لیست کشورها';
      backBtn.onclick = () => {
        selectedCountry = null;
        renderCountries(qEl.value ? qEl.value.trim().toLowerCase() : '');
      };
      countryListEl.appendChild(backBtn);

      const section = document.createElement('div');
      section.className = 'config-section';

      const nameEl = document.createElement('div');
      nameEl.className = 'country-name';
      nameEl.innerHTML = `<span>${country} (${countryGroups[country].length})</span>`;
      const copyAllBtn = document.createElement('button');
      copyAllBtn.className = 'small';
      copyAllBtn.textContent = 'کپی همه';
      copyAllBtn.onclick = () => copyAllConfigs(country);
      nameEl.appendChild(copyAllBtn);
      section.appendChild(nameEl);

      const configList = document.createElement('div');
      configList.className = 'config-list';

      let configs = countryGroups[country];
      let visibleCount = 0;

      function renderNext(n = 5) {
        for (let i = visibleCount; i < Math.min(visibleCount + n, configs.length); i++) {
          const cfg = configs[i];
          const cfgCard = document.createElement('div');
          cfgCard.className = 'config-card';
          const preview = document.createElement('div');
          preview.className = 'config-preview';
          preview.textContent = cfg.raw.split('\n').slice(0, 2).join('\n') + (cfg.raw.split('\n').length > 2 ? '\n...' : '');
          cfgCard.appendChild(preview);

          const actions = document.createElement('div');
          actions.className = 'actions';
          const copyBtn = document.createElement('button');
          copyBtn.className = 'small';
          copyBtn.textContent = 'کپی';
          copyBtn.onclick = () => copyToClipboard(cfg.raw);
          actions.appendChild(copyBtn);
          cfgCard.appendChild(actions);
          configList.appendChild(cfgCard);
        }
        visibleCount += n;
        showMoreBtn.style.display = visibleCount < configs.length ? 'block' : 'none';
      }

      const showMoreBtn = document.createElement('button');
      showMoreBtn.className = 'show-more';
      showMoreBtn.textContent = 'نمایش بیشتر';
      showMoreBtn.onclick = () => renderNext(5);

      renderNext(5);
      section.appendChild(configList);
      if (visibleCount < configs.length) section.appendChild(showMoreBtn);
      countryListEl.appendChild(section);
    }


    loadConfigs();
  </script>
</body>
</html>
